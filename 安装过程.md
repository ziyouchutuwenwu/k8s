# 安装过程

## 准备工作

### 关闭 swap

临时关闭

```bash
sudo swapoff -a
```

永久关闭

```bash
sudo sed -i '/ swap / s/^/#/' /etc/fstab
```

### 修改所有节点的主机名

```sh
hostnamectl set-hostname xxx
```

`/etc/hosts` 把所有需要通信的节点都加进去

### 同步时区

```sh
timedatectl set-timezone Asia/Shanghai
```

### 转发 ipv4 并让 iptables 看到桥接流量

```sh
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

sudo modprobe overlay
sudo modprobe br_netfilter

cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

sudo sysctl --system
```

### 运行时

- 安装

不要安装 `containerd`, 要装 `containerd.io`，否则 pause 的版本太低，pod 会经常 crash

```sh
apt install -y containerd.io
systemctl start containerd
mkdir -p /etc/containerd/
containerd config default > /etc/containerd/config.toml
sed -i 's/SystemdCgroup \= false/SystemdCgroup \= true/g' /etc/containerd/config.toml
systemctl restart containerd
```

- 配置

`crictl version` 报错

```sh
crictl config runtime-endpoint unix:///run/containerd/containerd.sock
```

## 配置

### 主节点配置

#### 初始化之前

测试的时候可执行避免反复下载

```sh
kubeadm config images pull --kubernetes-version v1.24.3 --image-repository registry.aliyuncs.com/google_containers
```

查看

```sh
kubeadm config images list --kubernetes-version v1.24.3 --image-repository registry.aliyuncs.com/google_containers
```

#### 初始化

参数说明

| 参数                          | 说明                                                     |
| ----------------------------- | -------------------------------------------------------- |
| --apiserver-advertise-address | master 和 worker 间能互相通信的 ip                       |
| --image-repository            | 指定镜像仓库                                             |
| --kubernetes-version          | 指定 k8s 版本                                            |
| --service-cidr                | 指定 service 运行网段（内部负载均衡网段）                |
| --pod-network-cidr            | 指定 pod 运行网段（后续的网络插件需要分配这个地址段 ip） |

```bash
kubeadm init --apiserver-advertise-address=192.168.56.11 --image-repository registry.aliyuncs.com/google_containers --service-cidr=10.96.0.0/16 --pod-network-cidr=10.244.0.0/16 --ignore-preflight-errors=all --kubernetes-version v1.24.3
```

或者

```bash
sudo kubeadm init --image-repository registry.aliyuncs.com/google_containers --pod-network-cidr=10.244.0.0/16
```

返回子节点加入集群的命令，类似

```bash
kubeadm join 10.167.11.153:6443 --token xxxxxx --discovery-token-ca-cert-hash sha256:yyyyy
```

#### 初始化失败

查看 log，导出到文件，否则不全，无法排查

```sh
sudo journalctl -xeu kubelet > err.log
```

发现是需要的 image 版本不对，可以这样

```sh
ctr -n k8s.io image pull registry.aliyuncs.com/google_containers/pause:3.6
ctr -n k8s.io image tag registry.aliyuncs.com/google_containers/pause:3.6 k8s.gcr.io/pause:3.6
```

#### 重新初始化

```sh
sudo kubeadm reset
```

#### 复制配置

普通用户账户下

```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

#### 安装网络插件

这个在 master 上装完以后，等会各个 node 都能自动装好，这个插件的安装和子节点加入集群的顺序没有先后，都可以

```bash
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
```

#### 等待初始化成功

需都为 ready

```bash
watch kubectl get pods -n kube-system -o wide
```

#### 添加子节点

```bash
kubeadm join 10.167.11.153:6443 --token xxxxxx --discovery-token-ca-cert-hash sha256:yyyyy
```

#### 移除子节点

先删除

```bash
kubectl drain xxx --delete-local-data --force --ignore-daemonsets
kubectl delete node xxx
```

### 子节点

#### 加入集群

使用 kubeadm join 加入集群

```bash
kubeadm join 192.168.56.11:6443 --token xxxxxx --discovery-token-ca-cert-hash sha256:yyyyy
```

如果子节点也需要执行 kubectl 命令,则需要复制 主节点的 `$HOME/.kube/config` 给子节点

#### 从集群中移除

被主节点移除以后，可执行

```bash
sudo kubeadm reset
```

#### 查看节点状态

```bash
watch kubectl get nodes --all-namespaces
```

### 单节点运行 master

```bash
kubectl taint node --all node-role.kubernetes.io/master-
```

将 master 恢复成 master only 状态

```bash
kubectl taint node master node-role.kubernetes.io/master="":NoSchedule
```
