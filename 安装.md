# 安装

## 关闭 swap

### 临时关闭 swap

如果没开, 执行`kubectl get pod`等命令会出现错误

```bash
sudo swapoff -a
```

### 永久关闭

```bash
sed -i '/ swap / s/^/#/' /etc/fstab
```

## 步骤

如果是国内安装，需要使用脚本先 pull 一些镜像

### 安装之前的配置

- 修改所有节点的主机名, `/etc/hostname` 改成自己节点名字, `/etc/hosts` 把所有需要通信的节点都加进去
- 先用 k8s_init_tool/k8s_manully_init 下载好基础镜像, 所有节点都需要运行

### master 节点

#### 初始化集群

需要 sudo

#### 本机

```bash
sudo kubeadm init \
 --apiserver-advertise-address=192.168.88.234 \
 --pod-network-cidr=10.244.0.0/16
```

或者

```bash
sudo kubeadm init --pod-network-cidr=10.244.0.0/16
```

#### vps 上直接

```bash
sudo kubeadm init --apiserver-advertise-address=vps 的公网 ip --pod-network-cidr=10.244.0.0/16
```

#### 重新初始化

```sh
sudo kubeadm reset
```

#### 复制配置

普通用户账户下

```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

如果子节点也需要执行 kubectl 命令,则需要从 master 节点复制这个过去

#### 返回子节点加入集群的命令，类似

```bash
sudo kubeadm join 10.167.11.153:6443 --token ccln7w.4bk9qkr5no7u6y3o --discovery-token-ca-cert-hash sha256:b72bf7d4c665c8aa66ccb5e9e8a3db13503ee94836267a6074ba1547a9ac85d8
```

### 子节点

#### 加入集群

##### 使用 kubeadm join 加入集群

##### 查看节点状态

```bash
kubectl get nodes --all-namespaces
```

- 提示安装网络插件，这个在 master 上装完以后，等会各个 node 都能自动装好，这个插件的安装和子节点加入集群的顺序没有先后，都可以

```bash
./docker_tag_pull quay.io/coreos/flannel:v0.11.0-amd64 jmgao1983/flannel:v0.11.0-amd64
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
```

### 注意

#### 检查

##### 装完以后，最好 master 上检查一下

```bash
kubectl get pods -n kube-system -o wide
```

##### Init:0/1 或者是 ContainerCreating 错误

如果发现有 Init:0/1 或者是 ContainerCreating，可能需要看下所在节点的镜像下载情况，可以分别在 master 和 node 上看
在 master 上 docker images，把需要的 image 在 node 主机上一个个 pull 下来，我在 pull 过程中，总是提示错误，最后在节点主机上做了域名和 ip 的映射才成功（实际上，域名和 ip 映射添加成功以后，等一会就可以看到节点的 pods 都 ok 了）。

#### 添加/删除子节点命令

##### 子节点使用类似以下命令加入集群

```bash
kubeadm join 10.167.11.153:6443 --token ccln7w.4bk9qkr5no7u6y3o --discovery-token-ca-cert-hash sha256:b72bf7d4c665c8aa66ccb5e9e8a3db13503ee94836267a6074ba1547a9ac85d8
```

如果加入失败,直接 reset

```bash
sudo kubeadm reset
```

另外,需要复制 主节点的 `$HOME/.kube/config` 给子节点,不然无法执行 kubectl 等命令

##### 主节点移除子节点

先删除

```bash
kubectl drain k8s-node --delete-local-data --force --ignore-daemonsets
kubectl delete node k8s-node
```

子节点内执行

```bash
sudo kubeadm reset
```

#### 单节点运行 master

单节点支持运行 pod
如果提示错误, 需要参考 `复制配置` 部分

```bash
kubectl taint node --all node-role.kubernetes.io/master-
```

将 master 恢复成 master only 状态

```bash
kubectl taint node master node-role.kubernetes.io/master="":NoSchedule
```
